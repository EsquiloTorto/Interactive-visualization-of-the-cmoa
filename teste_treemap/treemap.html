<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap">
    <meta charset="UTF-8">
    <title>CMOA Surface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-0">
        <div class="container">
            <a class="navbar-brand" href="../index.html">Home</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../kayo_testes/main.html">Fragments</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="../vis2/vis2.html">Timeline</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../teste_treemap/treemap.html">Treemap</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row frame main-row">
            <div class="col" id="conteudo">
                <h1 style="float: left; padding: 15px;"> CMOA Surface </h1>
                <h4><p>Bem-vindo a nossa pagina cultura dos países do mundo! Aqui,
                    você encontrará uma coleção incrível de artes de vários países,
                    todas exibidas no museu CMOA (Carnegie Museum of Art's).
                    Nós acreditamos que a arte é uma forma poderosa de expressão cultural,
                    e estamos animados em compartilhar essa experiência com você.</p>
    
                    <p>Nós temos uma grande variedade de países representados em nossa coleção,
                    incluindo African, American, Australian, Austrian, Belgian, British, Chinese,
                    Danish, Dutch, English, Flemish, French, German, Irish, Italian, Japanese, Mexican,
                    Persian, Russian, Scottish, Spanish e Swiss. Cada país tem uma rica história cultural
                    e artística, e estamos orgulhosos de poder exibir uma seleção de obras de arte que
                    capturam a essência dessas culturas.</p>
                </h4>
            </div>
            <div class="col" id="conteudo">
                <h4><p>Nossa coleção inclui uma variedade de estilos e gêneros, desde pinturas a
                    esculturas e fotografia. Ao explorar nossa coleção, você verá obras de arte
                    que são tanto clássicas quanto contemporâneas, e que representam a diversidade da
                    cultura em todo o mundo.</p>
    
                    <p>Para ajudá-lo a explorar nossa coleção, criamos uma visualização interativa
                    chamada CMOA Surface. Este gráfico único conecta imagens de artes separadas
                    por nacionalidade do autor, permitindo que você veja como as culturas se
                    relacionam entre si. Você pode selecionar o país que deseja ver usando o
                    dropdown abaixo, e classificar as artes por nacionalidade. Além disso, você
                    pode usar o zoom usando o scroll do mouse e, caso queira voltar à posição inicial,
                    basta apertar o botão "q". Também é possivel ver a classificação da arte e a quantidade
                    de artes de tal classificação ao colocar o mouse sobre a arte.</p>
                </h4>
            </div>
            <h5 style="text-align: center;">Aproveite a visualização CMOA Surface
                e descubra a riqueza da cultura em todo o mundo.
            </h5>
    
        </div>
    </div>
    <div id="raul">
        <div id="dropdown-container"> 
            <h3 style="margin-top: 0.3em;">SELECIONE A NACIONALIDADE DO ARTISTA:</h3>
            <!-- <h3>Selecione a nacionalidade do artista e explore diferentes culturas:</h3> -->
        <select id="filtro-nacionalidade">
            <option value="African" selected="selected" >African</option>
            <option value="American">American</option>
            <option value="Australian">Australian</option>
            <option value="Austrian">Austrian</option>
            <option value="Belgian">Belgian</option>
            <option value="British">British</option>
            <option value="Chinese">Chinese</option>
            <option value="Danish">Danish</option>
            <option value="Dutch">Dutch</option>
            <option value="English">English</option>
            <option value="Flemish">Flemish</option>
            <option value="French">French</option>
            <option value="German">German</option>
            <option value="Irish">Irish</option>
            <option value="Italian">Italian</option>
            <option value="Japanese">Japanese</option>
            <option value="Mexican">Mexican</option>
            <option value="Persian">Persian</option>
            <option value="Russian">Russian</option>
            <option value="Scottish">Scottish</option>
            <option value="Spanish">Spanish</option>
            <option value="Swiss">Swiss</option>
            <option value="undetermined">undetermined</option>
        </select>
        </div>
        <div id="treemap-container"></div>
    </div>
     

<br>
<br>


<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
// Caminho para o arquivo CSV
let url = 'data.csv';

// Conversor de CSV para JSON
d3.csv(url).then(function(data) {
    allData = data; // Guardar todos os dados
    redrawChart(); // Primeira renderização do gráfico
});

window.addEventListener('resize', function() {
    d3.select("body").select("svg").remove();
    redrawChart(); // Redesenhe o gráfico quando a janela for redimensionada
});

// create a tooltip
var tooltip = d3.select("body")
.append("div")
    .style("position", "absolute") // adicionar posição absoluta
    .style("z-index", "10")
    .style("visibility", "hidden")
    .attr("class", "tooltip");
 
function redrawChart() {
    let selectedNationality = d3.select("#filtro-nacionalidade").node().value;
    let filteredData = allData.filter(d => d.nationality === selectedNationality);

    nest = d3.nest()
        .key(function(d) { return d.classification; }) // alterado para classificação
        .entries(filteredData);
    
    drawTreemap(nest);

    d3.select("#filtro-nacionalidade").on("change", function() {
    selectedNationality = d3.select(this).node().value;
    filteredData = allData.filter(d => d.nationality === selectedNationality);
    nest = d3.nest()
        .key(function(d) { return d.classification; }) // mantenha a chave original
        .entries(filteredData);

    // Aqui estamos removendo o gráfico antigo antes de desenhar o novo.
    d3.select("body").select("svg").remove(); 
    drawTreemap(nest);
    });
}

window.addEventListener('resize', function() {
    d3.select("body").select("svg").remove();
    redrawChart(); // Redesenhe o gráfico quando a janela for redimensionada
});

function drawTreemap(data) {
    const margin = {top: 10, right: 15, bottom: 20 , left: 15};
    const dropdownContainerHeight = document.getElementById('dropdown-container').offsetHeight;
    
    // Aqui estamos pegando a altura da janela e subtraindo a altura do dropdown e da margem
    const height = window.innerHeight - dropdownContainerHeight - margin.top - margin.bottom;
    const width = window.innerWidth - margin.left - margin.right;
    

    let mouseover = function(d) {
        tooltip
        .style("visibility", "visible")  // tornar visível
        .style("opacity", 1);
        d3.select(this)
        .style("opacity", .5);
    };


    let mousemove = function(d) {
    let div = document.getElementById('treemap-container'); 
    let divRect = div.getBoundingClientRect();

    // Coordenadas do mouse relativas ao documento
    let mouseX = d3.event.pageX;
    let mouseY = d3.event.pageY;

    // Se o tooltip estiver muito à direita, mostre à esquerda do cursor
    const tooltipLeft = mouseX + tooltip.node().offsetWidth + 10 > divRect.right + window.scrollX
        ? mouseX - tooltip.node().offsetWidth - 10
        : mouseX + 10;
    // Se o tooltip estiver muito embaixo, mostre acima do cursor
    const tooltipTop = mouseY + tooltip.node().offsetHeight + 10 > divRect.bottom + window.scrollY
        ? mouseY - tooltip.node().offsetHeight - 10
        : mouseY + 10;

    tooltip
    .html("<div class='classification'>" + d.data.classification + " - " + Math.floor(d.data.total) + " Arts</div>" +
        "<br><div class='info'><strong>Title:</strong> " + d.data.title + "</div>" +
        "<div class='info'><strong>Source:</strong> " + d.data.full_name + "</div>" +
        "<div class='info'><strong>Creation date:</strong> " + d.data.creation_date + "</div>" +
        "<div class='info'><strong>Medium:</strong> " + d.data.medium + "</div>" +
        "<br><img class='image' src='" + d.data.small_img_url + "' style='max-width:200px; max-height:200px;' />")
        .style("left", tooltipLeft + "px")
        .style("top", tooltipTop + "px");
};


    let mouseleave = function(d) {
        tooltip
        .style("visibility", "hidden") // tornar invisível
        .style("opacity", 0)

        d3.select(this)
        .style("stroke", "none")
        .style("opacity", 1)
    };
    

    let zoom = d3.zoom()
        .scaleExtent([1, 100000])
        .on("zoom", function() {
            g.attr("transform", d3.event.transform);
        });

    let svg = d3.select("#treemap-container").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .call(zoom)
        .append("g");

    let g = svg.append("g");

    let zoomEnabled = false;  

    d3.select("body")
    .on("keydown", function() {
        if(d3.event.key === "q") {
            // Se o zoom estiver ativado, desabilite
            if(zoomEnabled) {
                zoomEnabled = false;
                svg.on(".zoom", null);
            }

            // Rola a página para o dropdown
            document.getElementById("dropdown-container").scrollIntoView({behavior: "smooth"});
        }
    })
    .on("keyup", function() {
        if(d3.event.key === "q") {
            zoomEnabled = false;
            svg.on(".zoom", null);

            // Reinicia a transformação do zoom
            g.transition()
            .duration(100)
            .call(zoom.transform, d3.zoomIdentity);

            // Reinicia o zoom na próxima vez que ele for habilitado
            zoom.transform(d3.select(svg.node().parentNode), d3.zoomIdentity);
        }
    });



    let treemap = d3.treemap()
    .size([width, height])
    .paddingTop(28) // alterado para o mesmo valor que o exemplo
    .paddingRight(1) // alterado para o mesmo valor que o exemplo
    .paddingInner(0) // alterado para o mesmo valor que o exemplo
    .paddingOuter(4) // adicionado como no exemplo
    .round(true);

    let root = d3.hierarchy({values: data}, function(d) { return d.values; })
        .sum(function(d) { return d.value; })
        .sort(function(a, b) { return b.value - a.value; });
  
    treemap(root);

    let parents = g.selectAll(".parent")
    .data(root.descendants())
    .enter().append("g")
    .filter(function (d) {
        return d.depth === 2; // Filtra os nós que são pais (neste caso, supomos que os pais estão na profundidade 1)
    });


    parents.append("rect")
    .attr("x", function (d) {
        return d.x0;
    })
    .attr("y", function (d) {
        return d.y0;
    })
    .attr("width", function (d) {
        return d.x1 - d.x0;
    })
    .attr("height", function (d) {
        return d.y1 - d.y0;
    })
    .style("fill", "none") // Nenhum preenchimento
    .style("stroke", 'black') // Cor da borda
    .style("stroke-width", "6"); // Largura da borda

    let node = g.selectAll(".node")
        .data(root.leaves())
        .enter()
        .append("g")
            .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave);


    node.append("rect")
        .attr("id", function(d) { return d.data.id; })
        .attr("width", function(d) { return d.x1 - d.x0; })
        .attr("height", function(d) { return d.y1- d.y0; })
        .style("fill", '#FDF5E6' )
        .style("stroke",'#FDF5E6')

        .style("stroke-width", "2");
    

    node.append("image")
    .attr("xlink:href", function(d) { return d.data.small_img_url; })
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", function(d) { return d.x1 - d.x0; }) 
    .attr("height", function(d) { return d.y1 - d.y0; });



}

</script>
</body>